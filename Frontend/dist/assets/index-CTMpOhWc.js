(function(){const D=document.createElement("link").relList;if(D&&D.supports&&D.supports("modulepreload"))return;for(const y of document.querySelectorAll('link[rel="modulepreload"]'))x(y);new MutationObserver(y=>{for(const h of y)if(h.type==="childList")for(const T of h.addedNodes)T.tagName==="LINK"&&T.rel==="modulepreload"&&x(T)}).observe(document,{childList:!0,subtree:!0});function c(y){const h={};return y.integrity&&(h.integrity=y.integrity),y.referrerPolicy&&(h.referrerPolicy=y.referrerPolicy),y.crossOrigin==="use-credentials"?h.credentials="include":y.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function x(y){if(y.ep)return;y.ep=!0;const h=c(y);fetch(y.href,h)}})();const ce={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};window.$=k=>document.getElementById(k);let B={};try{B=import.meta&&ce?ce:window.__env||{}}catch{B=window.__env||{}}const H=B.VITE_API_PLACES_ENDPOINT||"",C=B.VITE_API_BOOKINGS_ENDPOINT||"",F=B.VITE_SUPABASE_URL||"",S=B.VITE_SUPABASE_ANON_KEY||"";console.info("DEBUG: API_PLACES_ENDPOINT=",H||"(empty)");console.info("DEBUG: API_BOOKINGS_ENDPOINT=",C||"(empty)");console.info("DEBUG: VITE_SUPABASE_URL=",F?"(present)":"(empty)");console.info("DEBUG: VITE_SUPABASE_ANON_KEY present=",!!S);window.API_BOOKINGS_ENDPOINT=C;window.VITE_SUPABASE_URL=F;window.VITE_SUPABASE_ANON_KEY=S;window.__env=Object.assign(window.__env||{},{VITE_API_BOOKINGS_ENDPOINT:C,VITE_SUPABASE_URL:F,VITE_SUPABASE_ANON_KEY:S});(function(){const k=()=>new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),D=(t="x")=>t+Date.now().toString(36).slice(3)+Math.random().toString(36).slice(2,6),c=t=>String(t||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");function x(t){try{return JSON.parse(t)}catch{return{}}}const y="smn_groups_v1",h="smn_chats_v1",T="smn_books_v1",V=(t,e)=>{try{return JSON.parse(localStorage.getItem(t)||"null")||e}catch{return e}},I=(t,e)=>{try{localStorage.setItem(t,JSON.stringify(e))}catch{}};let v=V(y,null);v||(v=[{id:"g_mi_nomadi",name:"Nomadi Milano",city:"Milano",desc:"Incontri, coworking, eventi"},{id:"g_fi_foto",name:"Fotografi Firenze",city:"Firenze",desc:"Uscite fotografiche"}],I(y,v));let p=V(h,{global:[{user:"System",txt:"Benvenuto (demo)",time:k()}]}),N=V(T,[]),K=[{id:"p1",name:"Anna Conte",job:"UX Designer",city:"Milano",bio:"Amo il design e il caff√®."},{id:"p2",name:"Luca Bianchi",job:"Frontend Dev",city:"Milano",bio:"React, mappe e pizza."},{id:"p3",name:"Giulia Moretti",job:"Photographer",city:"Firenze",bio:"Fotografa freelance."}];const de={Milano:[45.4654,9.1866],Firenze:[43.7696,11.2558],Roma:[41.9028,12.4964],Torino:[45.0703,7.6869]},ue=["Milano","Roma","Firenze","Torino"];function J(t){const e=new Date;return e.setDate(e.getDate()+t),e.toISOString().split("T")[0]}function pe(t){const e=[];for(let r=1;r<=10;r++){const a=18+Math.floor(Math.random()*60);e.push({id:`hotel_${t}_${r}`,name:`${t} Hotel ${r}`,price_from:a,price_display:`‚Ç¨${a}`})}const o=[];for(let r=1;r<=10;r++){const a=8+Math.floor(Math.random()*45);o.push({id:`cowo_${t}_${r}`,name:`${t} Cowork ${r}`,price_from:a,price_display:`‚Ç¨${a}`})}const n=[{id:`ev_${t}_1`,title:`Digital Meetup ${t}`,date:J(5),desc:`Networking & talks in ${t}`},{id:`ev_${t}_2`,title:`Nomad Brunch ${t}`,date:J(12),desc:`Open meetup for nomads in ${t}`},{id:`ev_${t}_3`,title:`Photo Walk ${t}`,date:J(20),desc:`Explore ${t} and shoot photos`}],i=50+Math.floor(Math.random()*1500);return{hostels:e,coworkings:o,events:n,nomads:i}}const j=ue.map((t,e)=>{const o=pe(t),n=de[t]||[43.7,12.7],i=(e-1.5)*.02;return{id:`local_place_${t.toLowerCase()}`,slug:t.toLowerCase(),name:`${t} Hub`,description:`Demo listings for ${t}`,lat:n[0]+i,lng:n[1]+i,metadata:JSON.stringify(o)}});window._popupBookingStore=window._popupBookingStore||{},window._availableCities=window._availableCities||new Set,window._structuresIndex=window._structuresIndex||{};function _(t){if(!t)return t;const e=String(t).trim();return e.charAt(0).toUpperCase()+e.slice(1)}function fe(t){return"popup_"+String(t||"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")+"_"+Date.now().toString(36).slice(-5)}let f=null,E=null,O=null,Y=null;function z(){if(!f)try{f=L.map("map").setView([43.7,12.7],6.2),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(f),E=L.layerGroup().addTo(f)}catch(t){console.error("initMap",t)}}function me(t){E||(E=L.layerGroup().addTo(f));const e=parseFloat(t.lat),o=parseFloat(t.lng);if(!Number.isFinite(e)||!Number.isFinite(o))return;const n=L.marker([e,o]).addTo(E);n.bindPopup(ye(t)),n.on("click",()=>{try{f.setView([e,o],13)}catch{}})}function ge(t){z();const e=Array.isArray(t)?t:[t.lat,t.lng];if(!(!e||e.length!==2)){if(O){try{f.removeLayer(O)}catch{}O=null}O=L.circleMarker(e,{radius:10,color:"#FF6B35",fillOpacity:.9}).addTo(f);try{f.setView(e,14)}catch{}Y&&clearTimeout(Y),Y=setTimeout(()=>{try{f.removeLayer(O)}catch{}O=null},6e3)}}function te(t,e,o="price_from"){return Array.isArray(t)?t.slice().sort((i,r)=>Number(i[o]||1e9)-Number(r[o]||1e9)).slice(0,e):[]}function ye(t){const e=typeof t.metadata=="string"?x(t.metadata):t.metadata||{},o=Array.isArray(e.hostels)?e.hostels.map(g=>({name:g.name||g.title||"",price_from:Number(g.price_from||g.price_estimate||1e9),price_display:g.price_display||`‚Ç¨${g.price_from||g.price_estimate||""}`})):[],n=Array.isArray(e.coworkings)?e.coworkings.map(g=>({name:g.name||"",price_from:Number(g.price_from||g.price_estimate||1e9),price_display:g.price_display||`‚Ç¨${g.price_from||g.price_estimate||""}`})):[],i=Array.isArray(e.events)?e.events:[],r=te(o,3,"price_from"),a=te(n,2,"price_from"),l=i.length?i[0]:null,u=e.nomads_count??e.nomads??0,d=(g,Z)=>!g||!g.length?'<li class="muted">Nessun dato</li>':g.map(P=>{const ee=P.price_display||(P.price_from?`‚Ç¨${P.price_from}`:"‚Äî");return`<li>${c(P.name)} ‚Äî <strong>${c(ee)}</strong></li>`}).join(""),s=d(r),m=d(a),q=l?`<li>${c(l.title||"")}</li>`:'<li class="muted">Nessun evento</li>';return`
        <div class="popup-card" style="width:320px;font-family:Inter,Arial,sans-serif;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
            <div><div style="font-weight:800;">${c(t.name)}</div><div class="small" style="margin-top:4px">${c(t.description||"")}</div></div>
            <div style="background:#FF6B35;color:#fff;padding:6px 8px;border-radius:999px;font-weight:700">${c(String(u))} nomadi</div>
          </div>
          <div style="margin-top:8px;font-weight:700">Ostelli economici</div><ul style="margin:6px 0 0 14px;padding:0">${s}</ul>
          <div style="margin-top:8px;font-weight:700">Coworking (cheap)</div><ul style="margin:6px 0 0 14px;padding:0">${m}</ul>
          <div style="margin-top:8px;font-weight:700">Evento in evidenza</div><ul style="margin:6px 0 0 14px;padding:0">${q}</ul>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button onclick="(function(){ /* placeholder */ })();" class="btn btn-primary" style="flex:1; padding:8px 10px; border-radius:8px; border:0;">Apri chat & eventi</button>
            <button onclick="alert('Prenotazione demo per ${c(t.name)}');" class="btn" style="flex:1; padding:8px 10px; border-radius:8px">Prenota</button>
          </div>
          <div style="margin-top:8px;font-size:12px;color:#444"><strong>${c(e.weekly_highlight||"")}</strong></div>
        </div>
      `}function he(){f&&f.on("popupopen",function(t){try{const e=t.popup.getElement?t.popup.getElement():t.popup._container||null;if(!e)return;e.querySelectorAll("button").forEach(o=>{o.addEventListener("click",()=>{})})}catch(e){console.warn("popup delegation err",e)}})}function we(t){window._structuresIndex=window._structuresIndex||{},(!Array.isArray(t)||!t.length)&&(typeof j<"u"&&Array.isArray(j)?t=j.slice():t=[]),t.forEach(e=>{let o="";try{const n=typeof e.metadata=="string"?x(e.metadata):e.metadata||{};n&&n.city&&(o=_(n.city))}catch{}!o&&e.slug&&(o=_(String(e.slug).split("-")[0]||e.slug)),!o&&e.name&&(o=_(String(e.name).split(" ")[0]||e.name)),o||(o="Altro"),window._structuresIndex[o]=window._structuresIndex[o]||[],window._structuresIndex[o].push(e)}),Object.keys(window._structuresIndex).forEach(e=>{const o=new Set;window._structuresIndex[e]=window._structuresIndex[e].filter(n=>!n||!n.id||o.has(n.id)?!1:(o.add(n.id),!0))})}function Q(){const t=$("quickCity");if(!t)return;const e=new Set;window._availableCities&&window._availableCities.size&&window._availableCities.forEach(i=>e.add(_(i))),Object.keys(window._structuresIndex||{}).forEach(i=>e.add(_(i)));const n=Array.from(e).sort();t.innerHTML='<option value="">Tutte le citt√†</option>'+n.map(i=>`<option value="${i}">${i}</option>`).join("")}function b(){const t=$("quickCity");$("quickType"),$("quickPriceFilter");const e=$("quickStructure");if(!e||!t)return;const o=_(t.value||""),n=window._structuresIndex&&window._structuresIndex[o]?window._structuresIndex[o]:[].concat(...Object.values(window._structuresIndex||{}));e.innerHTML='<option value="">Seleziona struttura</option>',n.forEach(i=>{const r=typeof i.metadata=="string"?x(i.metadata):i.metadata||{},a=i.id||i.slug||i.name,l=i.name||r&&r.name||a,u=document.createElement("option");u.value=a,u.textContent=l,e.appendChild(u),window._popupBookingStore[a]||(window._popupBookingStore[a]={name:l,type:i.type||"",price:i.price_from||"",city:o||i.city||"",metadata:r,itemid:a})})}function ve(){const t=$("quickCity"),e=$("quickType"),o=$("quickPriceFilter");t&&t.addEventListener("change",()=>{b()}),e&&e.addEventListener("change",()=>{b()}),o&&o.addEventListener("change",()=>{b()})}function $e(t){var e;try{const o=_(t.city||""),n=t.name||"",i=t.type||"",r=t.price||"",a=t.itemid||"",l=$("quickCity");if(l&&o){let d=Array.from(l.options).find(s=>s.value===o);d||(d=document.createElement("option"),d.value=o,d.textContent=o,l.appendChild(d)),l.value=o,b()}const u=$("quickStructure");if(u){if(a&&window._popupBookingStore[a])u.value=a;else{const d=Array.from(u.options).find(s=>s.textContent.toLowerCase().includes((n||"").toLowerCase()));if(d)u.value=d.value;else{const s=fe(n||o+"_"+i),m=document.createElement("option");m.value=s,m.textContent=`${n}${r?" ‚Äî ‚Ç¨"+r:""}`,u.insertBefore(m,u.firstChild),u.value=s,window._popupBookingStore[s]={name:n,type:i,price:r,price_display:r?`‚Ç¨${r}`:"",city:o,source:"popup",timestamp:new Date().toISOString(),itemid:a||null}}}$("quickSearchNote")&&($("quickSearchNote").textContent="Selezionato dalla mappa: "+n);try{(e=document.querySelector("#map"))==null||e.scrollIntoView({behavior:"smooth",block:"center"})}catch{}}$("quickDate")&&$("quickDate").focus()}catch(o){console.error("selectStructureFromPopup error",o)}}async function oe(){f||z(),E||(E=L.layerGroup().addTo(f));let t=null;if(H&&H.length)try{const e=await fetch(H,{headers:{Accept:"application/json"}});if(e.ok){const o=await e.json();Array.isArray(o)&&o.length?t=o:console.warn("API_PLACES returned no places")}else console.warn("API_PLACES failed",e.status)}catch(e){console.warn("API_PLACES exception",e)}if(!t&&S&&F)try{const e=`${F.replace(/\/$/,"")}/rest/v1/places?select=id,slug,name,description,lat,lng,metadata&order=created_at.desc`,o=await fetch(e,{headers:{apikey:S,Authorization:"Bearer "+S,Accept:"application/json"}});if(o.ok){const n=await o.json();Array.isArray(n)&&n.length?t=n:console.warn("Supabase returned no places")}else console.warn("Supabase fetch failed",o.status)}catch(e){console.warn("Supabase fetch exception",e)}t||(t=j.slice());try{E&&E.clearLayers()}catch{}t.forEach(e=>{try{let o="";try{const n=typeof e.metadata=="string"?x(e.metadata):e.metadata||{};n&&n.city&&(o=_(n.city))}catch{}!o&&e.slug&&(o=_(String(e.slug).split("-")[0]||e.slug)),!o&&e.name&&(o=_(String(e.name).split(" ")[0]||e.name)),o&&window._availableCities.add(o),me(e)}catch(o){console.warn("add place error",o)}}),we(t),Q(),b()}let A=null,M=null;const ne=document.getElementById("postFile");ne&&ne.addEventListener("change",t=>{const e=t.target.files&&t.target.files[0];if(!e){A=null,$("postInfo")&&($("postInfo").textContent="");return}const o=new FileReader;o.onload=function(n){A={name:e.name,type:e.type,data:n.target.result},$("postInfo")&&($("postInfo").textContent=`${e.name} pronto per l'invio`)},o.readAsDataURL(e)});function _e(){$("postAttachPos")&&($("postAttachPos").disabled=!0,$("postAttachPos").textContent="Recupero..."),navigator.geolocation.getCurrentPosition(t=>{M={lat:t.coords.latitude,lng:t.coords.longitude},$("postInfo")&&($("postInfo").textContent="Posizione allegata"),$("postAttachPos")&&($("postAttachPos").disabled=!1,$("postAttachPos").textContent="Allega posizione")},t=>{$("postAttachPos")&&($("postAttachPos").disabled=!1,$("postAttachPos").textContent="Allega posizione"),alert("Impossibile ottenere la posizione: "+t.message)})}function be(){const t=$("postText")?$("postText").value.trim():"";if(!t&&!A&&!M)return alert("Scrivi qualcosa o allega file/posizione");const e=w&&w.type==="group"&&w.id?"group:"+w.id:w&&w.type==="private"&&w.id?"private:"+w.id:"global";p[e]=p[e]||[];const o={user:"You",txt:t,time:k(),file:A?{name:A.name,data:A.data,type:A.type}:null,location:M?{lat:M.lat,lng:M.lng}:null};p[e].push(o),I(h,p),e!=="global"&&(o.file||o.location)&&(p.global=p.global||[],p.global.push(Object.assign({},o)),I(h,p)),A=null,M=null,$("postText")&&($("postText").value=""),$("postInfo")&&($("postInfo").textContent="Pubblicato"),U(),W()}let w={type:"global",id:null};function R(t){w=t||{type:"global",id:null},U(),Ee()}function U(){const t=$("groupChat");if(!t)return;t.innerHTML="";const e=w.type==="global"?"global":w.type==="group"?"group:"+w.id:"private:"+w.id;p[e]=p[e]||[],p[e].forEach(o=>{const n=document.createElement("div");n.className="card";let i=`<div style="font-weight:700">${c(o.user)} <span class="small" style="margin-left:8px">${c(o.time||"")}</span></div><div class="small" style="margin-top:6px">${c(o.txt||"")}</div>`;o.file&&o.file.data&&(o.file.type&&o.file.type.startsWith("image/")?i+=`<a class="chat-attachment" href="${o.file.data}" target="_blank" rel="noopener">${c(o.file.name)}</a><img class="attachment-img" src="${o.file.data}" alt="${c(o.file.name)}"/>`:i+=`<a class="chat-attachment" href="${o.file.data}" target="_blank" rel="noopener">${c(o.file.name)}</a>`),o.location&&(i+=`<div class="small" style="margin-top:6px">üìç <a href="#" class="show-loc" data-lat="${o.location.lat}" data-lng="${o.location.lng}">Mostra posizione</a></div>`),n.innerHTML=i,t.appendChild(n)}),t.querySelectorAll(".show-loc").forEach(o=>{o.addEventListener("click",n=>{n.preventDefault();const i=parseFloat(n.currentTarget.dataset.lat),r=parseFloat(n.currentTarget.dataset.lng);ge([i,r])})})}function ie(){const t=$("chatInput")?$("chatInput").value.trim():"";if(!t)return;const e=w.type==="global"?"global":w.type==="group"?"group:"+w.id:"private:"+w.id;p[e]=p[e]||[],p[e].push({user:"You",txt:t,time:k()}),I(h,p),$("chatInput")&&($("chatInput").value=""),U(),e==="global"&&W(),setTimeout(()=>{p[e].push({user:"SMN Bot",txt:"Grazie per il messaggio!",time:k()}),I(h,p),U()},800)}function G(){const t=$("groupsList");t&&(t.innerHTML="",v.forEach(e=>{var n;const o=document.createElement("div");o.className="card",o.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${c(e.name)}</strong><div class="small">${c(e.city)}</div></div><div><button class="btn-outline" data-action="open" data-id="${c(e.id)}">Apri</button></div></div><div class="small" style="margin-top:6px">${c(e.desc||"")}</div>`,t.appendChild(o),(n=o.querySelector('[data-action="open"]'))==null||n.addEventListener("click",()=>Se(e.id))}))}function Se(t){const e=v.find(o=>o.id===t);R({type:"group",id:t}),$("centerTitle")&&($("centerTitle").textContent=e?`Gruppo: ${e.name}`:"[Gruppo]")}v.length&&v[0].id;function ke(){var i,r,a;const t=(i=$("gName"))==null?void 0:i.value.trim(),e=(r=$("gCity"))==null?void 0:r.value.trim(),o=(a=$("gDesc"))==null?void 0:a.value.trim();if(!t||!e)return alert("Nome e citt√† obbligatori");const n="g_"+t.toLowerCase().replace(/[^a-z0-9]+/g,"_")+"_"+Date.now().toString(36).slice(-4);v.push({id:n,name:t,city:e,desc:o}),I(y,v),se("modalGroup"),G()}function Ee(){$("btnJoin")&&($("btnJoin").style.display="none"),$("btnLeave")&&($("btnLeave").style.display="none")}async function re(t){if(!t)return null;try{const e="https://nominatim.openstreetmap.org/search?format=geojson&q="+encodeURIComponent(t)+"&limit=1&countrycodes=it",o=await fetch(e,{headers:{Accept:"application/json","User-Agent":"smn-demo/1.0"}});if(!o.ok)return null;const n=await o.json();if(n&&n.features&&n.features.length){const i=n.features[0].geometry.coordinates;return{coords:[i[1],i[0]]}}}catch(e){console.warn("geocode error",e)}return null}async function Ae(t,e,o,n=!1){try{const i=e[1],r=e[0],a=o[1],l=o[0],u=new URLSearchParams({overview:"full",geometries:"geojson"});n&&u.set("steps","true");const d=`https://router.project-osrm.org/route/v1/${t}/${i},${r};${a},${l}?`+u.toString(),s=await fetch(d);if(!s.ok)throw new Error("OSRM "+s.status);const m=await s.json();return!m.routes||!m.routes.length?null:m.routes[0]}catch(i){return console.warn("OSRM fetch error",i),null}}function xe(t,e,o,n,i={}){try{if(f||z(),window.routeLayer){try{f.removeLayer(window.routeLayer)}catch{}window.routeLayer=null}const r=t.geometry.coordinates.map(s=>[s[1],s[0]]);let a={color:"#FF6B35",weight:6,opacity:.95};n==="cycling-regular"&&(a={color:"#2EC44E",weight:6,opacity:.95}),n==="foot-walking"&&(a={color:"#f39c12",weight:5,opacity:.95,dashArray:"4,8"}),n==="public-transport"&&(a={color:"#7b5cff",weight:5,opacity:.9,dashArray:"8,8"});const l=L.polyline(r,a),u=L.circleMarker(e,{radius:6,color:"#045",fillColor:a.color,fillOpacity:1}),d=L.circleMarker(o,{radius:6,color:"#045",fillColor:"#3db9ff",fillOpacity:1});window.routeLayer=L.layerGroup([l,u,d]).addTo(f);try{f.fitBounds(l.getBounds().pad(.1))}catch{}if(i.alternativeRoute){const s=i.alternativeRoute.geometry.coordinates.map(m=>[m[1],m[0]]);L.polyline(s,{color:"#888",weight:4,dashArray:"6,8",opacity:.7}).addTo(f)}}catch(r){console.error("renderRoute error",r)}}async function Ie(){const t=$("from"),e=$("to"),o=$("routeInfo"),n=t?t.value.trim():"",i=e?e.value.trim():"";if(!n||!i){o&&(o.textContent="Inserisci partenza e arrivo");return}try{o&&(o.textContent="Localizzo...");const[r,a]=await Promise.all([re(n),re(i)]);if(!r||!a){o&&(o.textContent="Localit√† non trovate");return}o&&(o.textContent="Calcolo percorso...");const l=$("mode")?$("mode").value:"driving-car",d={"driving-car":"driving","cycling-regular":"cycling","foot-walking":"walking"}[l]||"driving",s=await Ae(d,r.coords,a.coords,!0);if(!s){o&&(o.textContent="Nessun percorso trovato");return}xe(s,r.coords,a.coords,l),o&&(o.textContent=`${(s.distance/1e3).toFixed(1)} km ‚Ä¢ ${Math.round(s.duration/60)} min`)}catch(r){console.error("calculateRoute error",r),o&&(o.textContent="Errore nel calcolo percorso")}}async function ae(){var r,a;const t=$("quickStructure");if(!t)return alert("Nessuna struttura selezionata");const e=t.value,o=window._popupBookingStore[e]||null;if(!o)return alert("Seleziona una struttura prima di prenotare");const n={name:o.name||"",city:o.city||"",type:o.type||"",date:((r=$("quickDate"))==null?void 0:r.value)||"",user:((a=$("quickName"))==null?void 0:a.value)||"You",metadata:o},i=D("bk");if(N.push({id:i,structureName:n.name,date:n.date,name:n.user,city:n.city}),I(T,N),$("bookings")&&($("bookings").textContent=`${N.length} prenotazione/i (demo)`),C&&C.length)try{const l={"Content-Type":"application/json"};S&&(l.apikey=S,l.Authorization="Bearer "+S),l.Prefer="return=representation";const u=[n];console.info("Invio booking a endpoint",C,"body=",u);const d=await fetch(C,{method:"POST",headers:l,body:JSON.stringify(u)}),s=await d.text();let m;try{m=JSON.parse(s)}catch{m=s}if(console.info("Booking response status=",d.status,"body=",m),!d.ok)throw new Error("booking failed "+d.status+" "+JSON.stringify(m));return $("quickMsg")&&($("quickMsg").textContent="Prenotazione inviata (server)"),m}catch(l){console.error("submitBooking error",l),$("quickMsg")&&($("quickMsg").textContent="Errore invio prenotazione (server)")}else $("quickMsg")&&($("quickMsg").textContent="Prenotazione salvata localmente (demo)")}function Le(){const t=$("profiles");t&&(t.innerHTML="",K.forEach(e=>{var n;const o=document.createElement("div");o.className="card",o.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${c(e.name)}</strong><div class="small">${c(e.job)} ‚Äî ${c(e.city)}</div></div><div><button class="btn-outline" data-action="open" data-id="${c(e.id)}">Apri</button></div></div><div class="small" style="margin-top:6px">${c(e.bio||"")}</div>`,t.appendChild(o),(n=o.querySelector('[data-action="open"]'))==null||n.addEventListener("click",()=>le(e.id))}))}function W(){const t=$("globalFeed");if(!t)return;t.innerHTML="",(p&&p.global?p.global.slice().reverse():[]).forEach(o=>{const n=document.createElement("div");n.className="card",n.innerHTML=`<div style="font-weight:700">${c(o.user||"")}</div><div class="small" style="margin-top:6px">${c(o.txt||"")}</div>`,t.appendChild(n)})}function Pe(){var t,e,o,n,i,r,a,l,u,d,s,m,q,g,Z,P;(t=$("btnNewGroup"))==null||t.addEventListener("click",()=>Ce("modalGroup")),(e=$("gCancel"))==null||e.addEventListener("click",()=>se("modalGroup")),(o=$("gSave"))==null||o.addEventListener("click",()=>ke()),(n=$("filterCity"))==null||n.addEventListener("change",()=>G()),(i=$("chatSend"))==null||i.addEventListener("click",()=>ie()),(r=$("chatInput"))==null||r.addEventListener("keypress",ee=>{ee.key==="Enter"&&ie()}),(a=$("btnSwitchGlobal"))==null||a.addEventListener("click",()=>R({type:"global",id:null})),(l=$("postAttachPos"))==null||l.addEventListener("click",()=>_e()),(u=$("postPublish"))==null||u.addEventListener("click",()=>be()),(d=$("btnOpenMap"))==null||d.addEventListener("click",()=>{z(),setTimeout(()=>f.invalidateSize&&f.invalidateSize(),200)}),(s=$("btnRoute"))==null||s.addEventListener("click",()=>Ie()),(m=$("quickSearch"))==null||m.addEventListener("click",()=>b()),(q=$("quickBook"))==null||q.addEventListener("click",()=>ae()),(g=$("quickCity"))==null||g.addEventListener("change",()=>{b()}),(Z=$("quickType"))==null||Z.addEventListener("change",()=>{b()}),(P=$("quickPriceFilter"))==null||P.addEventListener("change",()=>{b()}),ve()}function Ce(t){const e=$(t);e&&(e.classList.add("show"),e.setAttribute("aria-hidden","false"))}function se(t){const e=$(t);e&&(e.classList.remove("show"),e.setAttribute("aria-hidden","true"))}async function Te(){try{history.replaceState(null,"","/")}catch{}Pe(),G(),Le(),W(),Q(),X==null||X(),z(),he(),await oe(),R({type:"global",id:null}),$("bookings")&&($("bookings").textContent=N.length?`${N.length} prenotazione/i (demo)`:"Nessuna prenotazione"),console.info("Demo ready ‚Äî API_PLACES_ENDPOINT -> Supabase -> demo local fallback. All core features enabled."),window.smnDebug=()=>({GROUPS:v,CHATS:p,BOOKS:N,popupStore:window._popupBookingStore,structuresIndex:window._structuresIndex,availableCities:Array.from(window._availableCities||[])})}function X(){const t=$("quickStructure"),e=$("quickResults");if(!(!t||!e)){if(!t.childElementCount){const o=document.createElement("option");o.value="",o.textContent="Seleziona struttura",t.appendChild(o)}e.innerHTML=""}}function le(t){const e=K.find(o=>o.id===t);alert(e?`${e.name}
${e.job}
${e.city}

${e.bio}`:"Profilo non trovato")}function Ne(t){let e=t;const o=K.find(n=>n.id===t||n.name===t);o&&(e=o.id),R({type:"private",id:e})}window.openProfile=le,window.openPrivateChat=Ne,G(),window.selectStructureFromPopup=$e,window.submitBookingFromUI=ae,window.loadPlacesToMap=oe,window.populateQuickFilters=Q,Te()})();

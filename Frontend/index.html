<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Social Map Nomadi ‚Äî Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--bg:#FFF7EE;--card:#fff;--muted:#7B8A86;--accent:#FF6B35;--accent-alt:#FFC857}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#032B3A}
    .app{display:grid;grid-template-columns:320px 1fr 360px;gap:12px;height:100vh;padding:12px}
    .panel{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06);overflow:auto}
    .small{font-size:.88rem;color:var(--muted)}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn-outline{background:transparent;border:1px solid #e6eef2;padding:6px 8px;border-radius:8px}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-alt));color:#022;padding:8px 10px;border-radius:8px}
    .card{background:#fff;border-radius:8px;padding:10px;border:1px solid #eef2f6;margin-bottom:10px}
    .chat-window{height:30vh;overflow:auto;padding:8px;background:#fff;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px}
    #map{height:56vh;border-radius:10px;box-shadow:0 12px 40px rgba(2,6,23,0.08)}
    .row{display:flex;gap:8px}
    input, select, textarea{padding:8px;border-radius:8px;border:1px solid #e6eef2}
    .modal-bg{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal-bg.show{display:flex}
    .modal{background:#fff;padding:16px;border-radius:10px;min-width:320px;max-width:720px}
    .note{font-size:.85rem;color:var(--muted);margin-top:6px}
    .top-toggle{position:fixed;top:10px;right:10px;z-index:3000;display:flex;gap:8px;align-items:center}
    .view-hidden{display:none}
    @media(max-width:1000px){ .app{grid-template-columns:1fr;grid-auto-rows:auto} #map{height:320px} }
    .popup-card .muted{ color: #666; font-size: 12px; }
    .attachment-img{ max-width: 200px; border-radius:6px; display:block; margin-top:6px }
    .chat-attachment{ display:block; margin-top:6px; color:#0a6; text-decoration:underline; cursor:pointer }
  </style>
</head>
<body>
  <div class="top-toggle">
    <button id="showDemo" class="btn btn-outline">Mostra Demo</button>
    <button id="showReact" class="btn btn-primary">Mostra App React</button>
    <button id="openAuth" class="btn btn-primary">Autenticazione</button>
  </div>

  <div id="root" class="view-hidden" style="min-height:100vh"></div>

  <div id="demoContainer">
    <div class="app">
      <aside class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>Gruppi citt√†</strong>
            <div class="small">Crea, iscriviti e partecipa</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="accountBox" class="small">Account: You</div>
            <button id="btnSubscribe" class="btn-outline">Abbonati (demo)</button>
            <button id="btnNewGroup" class="btn-primary">+ Nuovo</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="small">Filtra per citt√†</div>
          <select id="filterCity" style="margin-top:8px;width:100%"></select>
        </div>

        <div id="groupsList" style="margin-top:12px;max-height:62vh;overflow:auto"></div>
      </aside>

      <main class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="centerTitle" style="font-weight:700">Chat: Globale</div>
            <div id="centerSubtitle" class="small">Seleziona chat globale, di gruppo o privata</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="btnOpenMap" class="btn-outline">Apri mappa</button>
            <button id="btnJoin" class="btn-primary" style="display:none">Iscriviti</button>
            <button id="btnLeave" class="btn-outline" style="display:none">Lascia</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:12px">
          <section>
            <div class="chat-window" id="groupChat"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="chatInput" placeholder="Scrivi nella chat attiva..." />
              <button id="chatSend" class="btn-primary">Invia</button>
              <button id="btnSwitchGlobal" class="btn-outline" title="Vai alla chat globale">Globale</button>
            </div>

            <div class="card" style="margin-top:12px">
              <strong>Post nel gruppo</strong>
              <textarea id="postText" rows="3" style="margin-top:8px;width:100%"></textarea>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <label class="btn-outline" style="padding:6px;cursor:pointer"><input id="postFile" type="file" accept="image/*,video/*" style="display:none"/>Carica file</label>
                <button id="postAttachPos" class="btn-outline">Allega posizione</button>
                <label style="margin-left:auto"><input id="postCross" type="checkbox"/> Condividi in Globale</label>
                <button id="postPublish" class="btn-primary">Pubblica</button>
              </div>
              <div id="postInfo" class="small" style="margin-top:8px;color:var(--muted)"></div>
            </div>

            <div class="card" style="margin-top:12px">
              <strong>Crea percorso</strong>
              <div class="row" style="margin-top:8px">
                <input id="from" placeholder="Partenza (e.g. Milano)"/>
                <input id="to" placeholder="Arrivo (e.g. Roma)"/>
              </div>
              <div class="row" style="margin-top:8px">
                <select id="mode">
                  <option value="driving-car">Auto</option>
                  <option value="public-transport">Pubblico</option>
                  <option value="cycling-regular">Bici</option>
                  <option value="foot-walking">A piedi</option>
                  <option value="eco">Eco</option>
                </select>
                <button id="btnRoute" class="btn-primary">Calcola</button>
              </div>
              <div id="routeInfo" class="small" style="margin-top:8px;color:var(--muted)"></div>
            </div>
          </section>

          <aside>
            <div style="font-weight:700">Mappa</div>
            <div id="map" style="margin-top:8px"></div>

            <div class="card" style="margin-top:12px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <strong>Prenotazione rapida</strong>
                <div class="small">Demo</div>
              </div>

              <div class="filters-row" style="margin-top:8px">
                <select id="quickCity" style="width:100%"><option value="">Tutte le citt√†</option></select>

                <select id="quickType" style="width:100%">
                  <option value="">Tutti</option>
                  <option value="hotel">Hotel</option>
                  <option value="hostel">Ostello</option>
                  <option value="coworking">Coworking</option>
                  <option value="event">Evento</option>
                </select>

                <select id="quickPriceFilter" style="width:100%">
                  <option value="">Tutti i prezzi</option>
                  <option value="cheap">&lt; 20‚Ç¨</option>
                  <option value="budget">20-40‚Ç¨</option>
                  <option value="premium">&gt; 40‚Ç¨</option>
                </select>
              </div>

              <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                <button id="quickSearch" class="btn-primary" style="flex:0 0 auto">Cerca</button>
                <div id="quickSearchNote" class="note">Premi "Cerca" per visualizzare le strutture.</div>
              </div>

              <select id="quickStructure" style="margin-top:8px;width:100%"></select>
              <div id="quickResults" class="results-list"></div>

              <input id="quickDate" type="date" style="margin-top:8px;width:100%"/>
              <input id="quickName" placeholder="Tuo nome" style="margin-top:8px;width:100%"/>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="quickBook" class="btn-primary">Prenota</button>
                <div id="quickMsg" class="small" style="align-self:center;color:var(--muted)"></div>
              </div>
              <div style="margin-top:10px"><strong>Prenotazioni demo</strong><div id="bookings" class="small" style="margin-top:6px;color:var(--muted)">Nessuna prenotazione</div></div>
            </div>
          </aside>
        </div>
      </main>

      <aside class="panel">
        <div><strong>Profili</strong><div class="small">Visualizza o apri chat privata</div></div>
        <div id="profiles" style="margin-top:12px"></div>
        <div style="margin-top:12px"><div style="font-weight:700">Feed Globale</div><div id="globalFeed" style="margin-top:8px;max-height:40vh;overflow:auto"></div></div>
      </aside>
    </div>

    <div class="modal-bg" id="modalGroup" aria-hidden="true">
      <div class="modal">
        <strong>Nuovo gruppo</strong>
        <div style="margin-top:8px">
          <input id="gName" placeholder="Nome gruppo" />
          <input id="gCity" placeholder="Citt√†" style="margin-top:8px"/>
          <textarea id="gDesc" rows="3" placeholder="Descrizione" style="margin-top:8px"></textarea>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <button id="gCancel" class="btn-outline">Annulla</button>
            <button id="gSave" class="btn-primary">Crea</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load runtime env (server provides /env.js) -->
  <script src="/env.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Main inline module (demo app) -->
  <script type="module">
  // Short helper
  window.$ = id => document.getElementById(id);

  // Robust env reading: import.meta.env when available, fallback to window.__env__
  // Wrapped in try/catch to avoid parser/runtime problems in environments that
  // might interpret 'import' unexpectedly.
  let env = {};
  try {
    // Import.meta is available in module contexts; read it inside try/catch
    // so older/non-module environments don't throw at parse time.
    env = (import.meta && import.meta.env) ? import.meta.env : (window.__env || {});
  } catch (e) {
    env = window.__env || {};
  }

  const API_PLACES_ENDPOINT = env.VITE_API_PLACES_ENDPOINT || "";
  const API_BOOKINGS_ENDPOINT = env.VITE_API_BOOKINGS_ENDPOINT || "";
  const VITE_SUPABASE_URL = env.VITE_SUPABASE_URL || "";
  const VITE_SUPABASE_ANON_KEY = env.VITE_SUPABASE_ANON_KEY || "";

  console.info('DEBUG: API_PLACES_ENDPOINT=', API_PLACES_ENDPOINT || '(empty)');
  console.info('DEBUG: API_BOOKINGS_ENDPOINT=', API_BOOKINGS_ENDPOINT || '(empty)');
  console.info('DEBUG: VITE_SUPABASE_URL=', VITE_SUPABASE_URL ? '(present)' : '(empty)');
  console.info('DEBUG: VITE_SUPABASE_ANON_KEY present=', Boolean(VITE_SUPABASE_ANON_KEY));

  // Expose important runtime env to window for easier debugging and console tests.
  window.API_BOOKINGS_ENDPOINT = API_BOOKINGS_ENDPOINT;
  window.VITE_SUPABASE_URL = VITE_SUPABASE_URL;
  window.VITE_SUPABASE_ANON_KEY = VITE_SUPABASE_ANON_KEY;
  window.__env = Object.assign(window.__env || {}, {
    VITE_API_BOOKINGS_ENDPOINT: API_BOOKINGS_ENDPOINT,
    VITE_SUPABASE_URL: VITE_SUPABASE_URL,
    VITE_SUPABASE_ANON_KEY: VITE_SUPABASE_ANON_KEY
  });

  (function(){
    "use strict";

    /* ---------- Utilities ---------- */
    const now = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const uid = (p='x') => p + Date.now().toString(36).slice(3) + Math.random().toString(36).slice(2,6);
    const escapeHtml = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    function safeJsonParse(s){ try { return JSON.parse(s); } catch(e) { return {}; } }

    /* ---------- Local storage keys & state ---------- */
    const K_GROUPS = 'smn_groups_v1';
    const K_CHATS = 'smn_chats_v1';
    const K_BOOKS = 'smn_books_v1';
    const load = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k)||'null')||f; }catch(e){return f;} };
    const save = (k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} };

    // persisted structures
    let GROUPS = load(K_GROUPS, null);
    if(!GROUPS){
      GROUPS = [
        { id:'g_mi_nomadi', name:'Nomadi Milano', city:'Milano', desc:'Incontri, coworking, eventi' },
        { id:'g_fi_foto', name:'Fotografi Firenze', city:'Firenze', desc:'Uscite fotografiche' }
      ];
      save(K_GROUPS, GROUPS);
    }
    let CHATS = load(K_CHATS, { global:[ { user:'System', txt:'Benvenuto (demo)', time: now() } ] });
    let BOOKS = load(K_BOOKS, []);
    let PROFILES = [
      { id:'p1', name:'Anna Conte', job:'UX Designer', city:'Milano', bio:'Amo il design e il caff√®.' },
      { id:'p2', name:'Luca Bianchi', job:'Frontend Dev', city:'Milano', bio:'React, mappe e pizza.' },
      { id:'p3', name:'Giulia Moretti', job:'Photographer', city:'Firenze', bio:'Fotografa freelance.' }
    ];

    // demo places fallback & structure generator (10 hotels + 10 coworkings + 3 events per city)
    const CITY_COORDS = { Milano:[45.4654,9.1866], Firenze:[43.7696,11.2558], Roma:[41.9028,12.4964], Torino:[45.0703,7.6869] };
    const DEMO_CITIES = ['Milano','Roma','Firenze','Torino'];
    function futureDate(daysAhead){ const d=new Date(); d.setDate(d.getDate()+daysAhead); return d.toISOString().split('T')[0]; }
    function genDemoListings(city){
      const hotels=[]; for(let i=1;i<=10;i++){ const base=18+Math.floor(Math.random()*60); hotels.push({ id:`hotel_${city}_${i}`, name:`${city} Hotel ${i}`, price_from:base, price_display:`‚Ç¨${base}` }); }
      const coworkings=[]; for(let i=1;i<=10;i++){ const daily=8+Math.floor(Math.random()*45); coworkings.push({ id:`cowo_${city}_${i}`, name:`${city} Cowork ${i}`, price_from:daily, price_display:`‚Ç¨${daily}` }); }
      const events=[
        { id:`ev_${city}_1`, title:`Digital Meetup ${city}`, date:futureDate(5), desc:`Networking & talks in ${city}` },
        { id:`ev_${city}_2`, title:`Nomad Brunch ${city}`, date:futureDate(12), desc:`Open meetup for nomads in ${city}` },
        { id:`ev_${city}_3`, title:`Photo Walk ${city}`, date:futureDate(20), desc:`Explore ${city} and shoot photos` }
      ];
      const nomads=50+Math.floor(Math.random()*1500);
      return { hostels:hotels, coworkings:coworkings, events:events, nomads:nomads };
    }
    const localPlaces = DEMO_CITIES.map((city,idx)=>{ const meta=genDemoListings(city); const base=CITY_COORDS[city]||[43.7,12.7]; const offset=(idx-1.5)*0.02; return { id:`local_place_${city.toLowerCase()}`, slug:city.toLowerCase(), name:`${city} Hub`, description:`Demo listings for ${city}`, lat: base[0]+offset, lng: base[1]+offset, metadata: JSON.stringify(meta) }; });

    /* ---------- Globals used by booking popup and UI ---------- */
    window._popupBookingStore = window._popupBookingStore || {}; // id -> object
    window._availableCities = window._availableCities || new Set();
    window._structuresIndex = window._structuresIndex || {}; // city -> [structures]
    function normalizeCityName(name){ if(!name) return name; const s=String(name).trim(); return s.charAt(0).toUpperCase()+s.slice(1); }
    function _popupBookingId(name){ return 'popup_'+String(name||'').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'')+'_'+Date.now().toString(36).slice(-5); }

    /* ---------- Map & marker helpers ---------- */
    let map=null, markersLayer=null, highlightMarker=null, highlightTimeout=null;
    function initMap(){ if(map) return; try{ map=L.map('map').setView([43.7,12.7],6.2); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map); markersLayer=L.layerGroup().addTo(map);}catch(e){console.error('initMap',e);} }
    function addPlaceMarkerToMap(place){ if(!markersLayer) markersLayer=L.layerGroup().addTo(map); const lat=parseFloat(place.lat), lng=parseFloat(place.lng); if(!Number.isFinite(lat)||!Number.isFinite(lng)) return; const m = L.marker([lat,lng]).addTo(markersLayer); m.bindPopup(buildPlacePopupHtml(place)); m.on('click', ()=>{ try{ map.setView([lat,lng], 13); }catch(e){} }); }
    function showLocationOnMap(location){ initMap(); const coords=Array.isArray(location)?location:[location.lat,location.lng]; if(!coords||coords.length!==2) return; if(highlightMarker){ try{ map.removeLayer(highlightMarker);}catch(e){} highlightMarker=null; } highlightMarker = L.circleMarker(coords,{ radius:10, color:'#FF6B35', fillOpacity:0.9 }).addTo(map); try{ map.setView(coords,14); }catch(e){} if(highlightTimeout) clearTimeout(highlightTimeout); highlightTimeout=setTimeout(()=>{ try{ map.removeLayer(highlightMarker); }catch(e){} highlightMarker=null; }, 6000); }

    /* ---------- Build popup html (cheapest items) ---------- */
    function pickCheapest(list,count,priceField='price_from'){ if(!Array.isArray(list)) return []; const sorted=list.slice().sort((a,b)=> (Number(a[priceField]||1e9) - Number(b[priceField]||1e9))); return sorted.slice(0,count); }
    function buildPlacePopupHtml(place){
      const meta=(typeof place.metadata==='string')?safeJsonParse(place.metadata):(place.metadata||{});
      const hostels=Array.isArray(meta.hostels)?meta.hostels.map(h=>({ name:h.name||h.title||'', price_from:Number(h.price_from||h.price_estimate||1e9), price_display:h.price_display||(`‚Ç¨${h.price_from||h.price_estimate||''}`) })):[];
      const coworkings=Array.isArray(meta.coworkings)?meta.coworkings.map(c=>({ name:c.name||'', price_from:Number(c.price_from||c.price_estimate||1e9), price_display:c.price_display||(`‚Ç¨${c.price_from||c.price_estimate||''}`) })):[];
      const events=Array.isArray(meta.events)?meta.events:[];
      const cheapestHostels=pickCheapest(hostels,3,'price_from'); const cheapestCow=pickCheapest(coworkings,2,'price_from'); const featuredEvent = events.length?events[0]:null;
      const nomads = meta.nomads_count ?? meta.nomads ?? 0;
      const renderItems=(items,type)=>{ if(!items||!items.length) return '<li class="muted">Nessun dato</li>'; return items.map(it=>{ const priceText = it.price_display|| (it.price_from?`‚Ç¨${it.price_from}`:'‚Äî'); return `<li>${escapeHtml(it.name)} ‚Äî <strong>${escapeHtml(priceText)}</strong></li>` }).join(''); }
      const hostelsHtml = renderItems(cheapestHostels,'hostel'); const cowoHtml = renderItems(cheapestCow,'coworking'); const eventHtml = featuredEvent? `<li>${escapeHtml(featuredEvent.title||'')}</li>` : '<li class="muted">Nessun evento</li>';
      return `
        <div class="popup-card" style="width:320px;font-family:Inter,Arial,sans-serif;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
            <div><div style="font-weight:800;">${escapeHtml(place.name)}</div><div class="small" style="margin-top:4px">${escapeHtml(place.description||'')}</div></div>
            <div style="background:#FF6B35;color:#fff;padding:6px 8px;border-radius:999px;font-weight:700">${escapeHtml(String(nomads))} nomadi</div>
          </div>
          <div style="margin-top:8px;font-weight:700">Ostelli economici</div><ul style="margin:6px 0 0 14px;padding:0">${hostelsHtml}</ul>
          <div style="margin-top:8px;font-weight:700">Coworking (cheap)</div><ul style="margin:6px 0 0 14px;padding:0">${cowoHtml}</ul>
          <div style="margin-top:8px;font-weight:700">Evento in evidenza</div><ul style="margin:6px 0 0 14px;padding:0">${eventHtml}</ul>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button onclick="(function(){ /* placeholder */ })();" class="btn btn-primary" style="flex:1; padding:8px 10px; border-radius:8px; border:0;">Apri chat & eventi</button>
            <button onclick="alert('Prenotazione demo per ${escapeHtml(place.name)}');" class="btn" style="flex:1; padding:8px 10px; border-radius:8px">Prenota</button>
          </div>
          <div style="margin-top:8px;font-size:12px;color:#444"><strong>${escapeHtml(meta.weekly_highlight||'')}</strong></div>
        </div>
      `;
    }

    /* ---------- Popup delegation ---------- */
    function attachPopupDelegation(){ if(!map) return; map.on('popupopen', function(e){ try{ const container = e.popup.getElement ? e.popup.getElement() : (e.popup._container || null); if(!container) return; container.querySelectorAll('button').forEach(btn=>{ btn.addEventListener('click', ()=>{}); }); }catch(e){console.warn('popup delegation err',e);} }); }

    /* ---------- Structures index / quickStructure population ---------- */
    function buildMasterStructuresIndex(places){
      window._structuresIndex = window._structuresIndex || {};
      if(!Array.isArray(places) || !places.length){ if(typeof localPlaces !== 'undefined' && Array.isArray(localPlaces)) places = localPlaces.slice(); else places = []; }
      places.forEach(p=>{ let city=''; try{ const meta=(typeof p.metadata==='string')?safeJsonParse(p.metadata):(p.metadata||{}); if(meta && meta.city) city = normalizeCityName(meta.city); }catch(e){} if(!city && p.slug) city = normalizeCityName(String(p.slug).split('-')[0]||p.slug); if(!city && p.name) city = normalizeCityName(String(p.name).split(' ')[0]||p.name); if(!city) city = 'Altro'; window._structuresIndex[city]=window._structuresIndex[city]||[]; window._structuresIndex[city].push(p); });
      Object.keys(window._structuresIndex).forEach(city=>{ const seen=new Set(); window._structuresIndex[city]=window._structuresIndex[city].filter(s=>{ if(!s||!s.id) return false; if(seen.has(s.id)) return false; seen.add(s.id); return true; }); });
    }

    function populateQuickFilters(){
      const citySel = $('quickCity'); if(!citySel) return; const chosen=new Set(); if(window._availableCities && window._availableCities.size) window._availableCities.forEach(c=>chosen.add(normalizeCityName(c))); const cities = Object.keys(window._structuresIndex||{}); cities.forEach(c=> chosen.add(normalizeCityName(c))); const opts = Array.from(chosen).sort(); citySel.innerHTML = '<option value=\"\">Tutte le citt√†</option>' + opts.map(c=>`<option value="${c}">${c}</option>`).join(''); }

    function populateQuickStructures(){
      const citySel = $('quickCity'), typeSel=$('quickType'), priceSel=$('quickPriceFilter'), structSel=$('quickStructure'); if(!structSel||!citySel) return; const city=normalizeCityName(citySel.value||''); const list = (window._structuresIndex && window._structuresIndex[city]) ? window._structuresIndex[city] : [].concat(...Object.values(window._structuresIndex||{})); structSel.innerHTML = '<option value=\"\">Seleziona struttura</option>'; list.forEach(p=>{ const meta=(typeof p.metadata==='string')?safeJsonParse(p.metadata):(p.metadata||{}); const id = p.id || p.slug || p.name; const label = p.name || (meta && meta.name) || id; const opt = document.createElement('option'); opt.value = id; opt.textContent = label; structSel.appendChild(opt); if(!window._popupBookingStore[id]) window._popupBookingStore[id] = { name: label, type: p.type||'', price: p.price_from||'', city: city||p.city||'' , metadata: meta, itemid: id }; });
    }

    function bindQuickStructureAutoUpdate(){ const citySel = $('quickCity'), typeSel=$('quickType'), priceSel=$('quickPriceFilter'); if(citySel) citySel.addEventListener('change', ()=>{ populateQuickStructures(); }); if(typeSel) typeSel.addEventListener('change', ()=>{ populateQuickStructures(); }); if(priceSel) priceSel.addEventListener('change', ()=>{ populateQuickStructures(); }); }

    /* ---------- When popup item clicked: fill booking UI ---------- */
    function selectStructureFromPopup(payload){
      try{
        const city=normalizeCityName(payload.city||'');
        const name=payload.name||'';
        const type=payload.type||'';
        const price=payload.price||'';
        const itemid=payload.itemid||'';

        const citySel = $('quickCity');
        if(citySel && city){
          let opt=Array.from(citySel.options).find(o=>o.value===city);
          if(!opt){ opt=document.createElement('option'); opt.value=city; opt.textContent=city; citySel.appendChild(opt); }
          citySel.value=city;
          populateQuickStructures();
        }

        const structSel=$('quickStructure');
        if(structSel){
          // if itemid is present and in store prefer it
          if(itemid && window._popupBookingStore[itemid]){ structSel.value = itemid; }
          else {
            const match = Array.from(structSel.options).find(o=> o.textContent.toLowerCase().includes((name||'').toLowerCase()));
            if(match){ structSel.value = match.value; }
            else {
              const optId = _popupBookingId(name || (city+'_'+type));
              const opt = document.createElement('option');
              opt.value = optId;
              opt.textContent = `${name}${price ? ' ‚Äî ‚Ç¨'+price : ''}`;
              structSel.insertBefore(opt, structSel.firstChild);
              structSel.value = optId;
              window._popupBookingStore[optId] = { name, type, price, price_display: price ? `‚Ç¨${price}` : '', city, source:'popup', timestamp:new Date().toISOString(), itemid: itemid || null };
            }
          }
          if($('quickSearchNote')) $('quickSearchNote').textContent = 'Selezionato dalla mappa: ' + name;
          try{ document.querySelector('#map')?.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
        }
        if($('quickDate')) $('quickDate').focus();
      }catch(err){ console.error('selectStructureFromPopup error', err); }
    }

    /* ---------- Load places (API->Supabase->demo) ---------- */
    async function loadPlacesToMap(){
      if(!map) initMap();
      if(!markersLayer) markersLayer=L.layerGroup().addTo(map);
      let places = null;

      if(API_PLACES_ENDPOINT && API_PLACES_ENDPOINT.length){
        try{ const r=await fetch(API_PLACES_ENDPOINT, { headers:{ 'Accept':'application/json' } }); if(r.ok){ const json=await r.json(); if(Array.isArray(json) && json.length) places = json; else console.warn('API_PLACES returned no places'); } else console.warn('API_PLACES failed', r.status); } catch(e){ console.warn('API_PLACES exception', e); }
      }

      // If no external API, try Supabase REST if anon key + url present
      if(!places && VITE_SUPABASE_ANON_KEY && VITE_SUPABASE_URL){
        try{
          const url = `${VITE_SUPABASE_URL.replace(/\/$/,'')}/rest/v1/places?select=id,slug,name,description,lat,lng,metadata&order=created_at.desc`;
          const res = await fetch(url, { headers:{ 'apikey':VITE_SUPABASE_ANON_KEY, 'Authorization':'Bearer '+VITE_SUPABASE_ANON_KEY, 'Accept':'application/json' } });
          if(res.ok){
            const data = await res.json();
            if(Array.isArray(data) && data.length) places = data;
            else console.warn('Supabase returned no places');
          } else {
            console.warn('Supabase fetch failed', res.status);
          }
        } catch(e){
          console.warn('Supabase fetch exception', e);
        }
      }

      if(!places) places = localPlaces.slice();

      // clear markers
      try{ if(markersLayer) markersLayer.clearLayers(); } catch(e){}

      places.forEach(p=>{
        try{
          // gather city
          let city='';
          try{ const meta=(typeof p.metadata==='string')?safeJsonParse(p.metadata):(p.metadata||{}); if(meta && meta.city) city = normalizeCityName(meta.city); }catch(e){}
          if(!city && p.slug) city = normalizeCityName(String(p.slug).split('-')[0]||p.slug);
          if(!city && p.name) city = normalizeCityName(String(p.name).split(' ')[0]||p.name);
          if(city) window._availableCities.add(city);
          addPlaceMarkerToMap(p);
        }catch(e){ console.warn('add place error', e); }
      });

      buildMasterStructuresIndex(places);
      populateQuickFilters();
      populateQuickStructures();
    }

    /* ---------- Chat, uploads, posts ---------- */
    // Ensure user pending file is read as dataURL to persist
    let pendingFile = null;
    let pendingPos = null;

    // File input change: read file as DataURL and store name+data
    const fileInput = document.getElementById('postFile');
    if(fileInput){
      fileInput.addEventListener('change', e=>{
        const f = e.target.files && e.target.files[0];
        if(!f){ pendingFile=null; if($('postInfo')) $('postInfo').textContent=''; return; }
        const reader = new FileReader();
        reader.onload = function(evt){
          pendingFile = { name: f.name, type: f.type, data: evt.target.result };
          if($('postInfo')) $('postInfo').textContent = `${f.name} pronto per l'invio`;
        };
        reader.readAsDataURL(f);
      });
    }

    function attachPosition(){
      if($('postAttachPos')){ $('postAttachPos').disabled=true; $('postAttachPos').textContent='Recupero...'; }
      navigator.geolocation.getCurrentPosition(pos=>{
        pendingPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        if($('postInfo')) $('postInfo').textContent = 'Posizione allegata';
        if($('postAttachPos')){ $('postAttachPos').disabled=false; $('postAttachPos').textContent='Allega posizione'; }
      }, err=>{
        if($('postAttachPos')){ $('postAttachPos').disabled=false; $('postAttachPos').textContent='Allega posizione'; }
        alert('Impossibile ottenere la posizione: '+err.message);
      });
    }

    // publishPost: create chat message with file and/or location and persist to CHATS + localStorage
    function publishPost(){
      const txt = $('postText')?$('postText').value.trim():'';
      if(!txt && !pendingFile && !pendingPos) return alert('Scrivi qualcosa o allega file/posizione');
      const targetKey = (activeChat && activeChat.type==='group' && activeChat.id) ? ('group:'+activeChat.id) : (activeChat && activeChat.type==='private' && activeChat.id ? ('private:'+activeChat.id) : 'global');
      CHATS[targetKey] = CHATS[targetKey] || [];
      const post = { user: 'You', txt: txt, time: now(), file: pendingFile? { name: pendingFile.name, data: pendingFile.data, type: pendingFile.type } : null, location: pendingPos ? { lat: pendingPos.lat, lng: pendingPos.lng } : null };
      CHATS[targetKey].push(post);
      save(K_CHATS, CHATS);
      // if has location or file and not global, push to global feed too (mirroring previous logic)
      if(targetKey!=='global' && (post.file || post.location)){
        CHATS.global = CHATS.global || [];
        CHATS.global.push(Object.assign({}, post));
        save(K_CHATS,CHATS);
      }
      // reset inputs
      pendingFile = null; pendingPos = null;
      if($('postText')) $('postText').value='';
      if($('postInfo')) $('postInfo').textContent='Pubblicato';
      renderActiveChat();
      renderGlobalFeed();
    }

    // renderActiveChat and chat send
    let activeChat = { type:'global', id:null };
    function setActiveChat(obj){ activeChat = obj || { type:'global', id:null }; renderActiveChat(); updateJoinButtons(); }
    function renderActiveChat(){
      const win = $('groupChat'); if(!win) return;
      win.innerHTML = '';
      const key = (activeChat.type==='global') ? 'global' : (activeChat.type==='group' ? 'group:'+activeChat.id : 'private:'+activeChat.id);
      CHATS[key] = CHATS[key] || [];
      CHATS[key].forEach(m=>{
        const d = document.createElement('div'); d.className='card';
        let html = `<div style="font-weight:700">${escapeHtml(m.user)} <span class="small" style="margin-left:8px">${escapeHtml(m.time||'')}</span></div><div class="small" style="margin-top:6px">${escapeHtml(m.txt||'')}</div>`;
        if(m.file && m.file.data){
          // show inline image if image
          if(m.file.type && m.file.type.startsWith('image/')){
            html += `<a class="chat-attachment" href="${m.file.data}" target="_blank" rel="noopener">${escapeHtml(m.file.name)}</a><img class="attachment-img" src="${m.file.data}" alt="${escapeHtml(m.file.name)}"/>`;
          } else {
            html += `<a class="chat-attachment" href="${m.file.data}" target="_blank" rel="noopener">${escapeHtml(m.file.name)}</a>`;
          }
        }
        if(m.location){
          html += `<div class="small" style="margin-top:6px">üìç <a href="#" class="show-loc" data-lat="${m.location.lat}" data-lng="${m.location.lng}">Mostra posizione</a></div>`;
        }
        d.innerHTML = html;
        win.appendChild(d);
      });
      // bind show-loc links
      win.querySelectorAll('.show-loc').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          const lat = parseFloat(e.currentTarget.dataset.lat), lng = parseFloat(e.currentTarget.dataset.lng);
          showLocationOnMap([lat,lng]);
        });
      });
    }

    function sendChat(){
      const text = $('chatInput')?$('chatInput').value.trim():'';
      if(!text) return;
      const key = (activeChat.type==='global') ? 'global' : (activeChat.type==='group' ? 'group:'+activeChat.id : 'private:'+activeChat.id);
      CHATS[key] = CHATS[key] || [];
      CHATS[key].push({ user:'You', txt:text, time: now() });
      save(K_CHATS, CHATS);
      if($('chatInput')) $('chatInput').value='';
      renderActiveChat();
      if(key==='global') renderGlobalFeed();
      // simple bot reply
      setTimeout(()=>{ CHATS[key].push({ user:'SMN Bot', txt:'Grazie per il messaggio!', time: now() }); save(K_CHATS,CHATS); renderActiveChat(); }, 800);
    }

    /* ---------- Groups & createGroup ---------- */
    function renderGroups(){ const wrap=$('groupsList'); if(!wrap) return; wrap.innerHTML=''; GROUPS.forEach(g=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(g.name)}</strong><div class="small">${escapeHtml(g.city)}</div></div><div><button class="btn-outline" data-action="open" data-id="${escapeHtml(g.id)}">Apri</button></div></div><div class="small" style="margin-top:6px">${escapeHtml(g.desc||'')}</div>`; wrap.appendChild(el); el.querySelector('[data-action="open"]')?.addEventListener('click', ()=>openGroup(g.id)); }); }
    function openGroup(id){ const g = GROUPS.find(x=>x.id===id); selectedGroup=id; setActiveChat({ type:'group', id }); if($('centerTitle')) $('centerTitle').textContent = g?`Gruppo: ${g.name}`:'[Gruppo]'; }
    let selectedGroup = GROUPS.length?GROUPS[0].id:null;
    function createGroup(){ const name=$('gName')?.value.trim(), city=$('gCity')?.value.trim(), desc=$('gDesc')?.value.trim(); if(!name||!city) return alert('Nome e citt√† obbligatori'); const id = 'g_'+name.toLowerCase().replace(/[^a-z0-9]+/g,'_')+'_'+Date.now().toString(36).slice(-4); GROUPS.push({ id, name, city, desc }); save(K_GROUPS, GROUPS); hideModal('modalGroup'); renderGroups(); }

    function updateJoinButtons(){ const joined = selectedGroup && true; if($('btnJoin')) $('btnJoin').style.display = 'none'; if($('btnLeave')) $('btnLeave').style.display = 'none'; }

    /* ---------- Route calc (Nominatim + OSRM) ---------- */
    async function geocodeSafe(query){
      if(!query) return null;
      try{ const url = 'https://nominatim.openstreetmap.org/search?format=geojson&q='+encodeURIComponent(query)+'&limit=1&countrycodes=it'; const r=await fetch(url,{ headers:{ 'Accept':'application/json','User-Agent':'smn-demo/1.0' } }); if(!r.ok) return null; const j = await r.json(); if(j && j.features && j.features.length) { const c = j.features[0].geometry.coordinates; return { coords: [c[1], c[0]] }; } }catch(e){ console.warn('geocode error',e); } return null;
    }
    async function fetchOsrmRoute(profile, fromCoords, toCoords, includeSteps=false){
      try{
        const lon1=fromCoords[1], lat1=fromCoords[0], lon2=toCoords[1], lat2=toCoords[0];
        const params = new URLSearchParams({ overview:'full', geometries:'geojson' }); if(includeSteps) params.set('steps','true');
        const url = `https://router.project-osrm.org/route/v1/${profile}/${lon1},${lat1};${lon2},${lat2}?`+params.toString();
        const r = await fetch(url); if(!r.ok) throw new Error('OSRM '+r.status); const data = await r.json(); if(!data.routes||!data.routes.length) return null; return data.routes[0];
      }catch(e){ console.warn('OSRM fetch error', e); return null; }
    }
    function renderRoute(route, fromCoords, toCoords, mode, opts={}){
      try{
        if(!map) initMap();
        if(window.routeLayer){ try{ map.removeLayer(window.routeLayer); }catch(e){} window.routeLayer=null; }
        const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);
        let style = { color:'#FF6B35', weight:6, opacity:0.95 };
        if(mode==='cycling-regular') style = { color:'#2EC44E', weight:6, opacity:0.95 };
        if(mode==='foot-walking') style = { color:'#f39c12', weight:5, opacity:0.95, dashArray:'4,8' };
        if(mode==='public-transport') style = { color:'#7b5cff', weight:5, opacity:0.9, dashArray:'8,8' };
        const line = L.polyline(coords, style);
        const fromMarker = L.circleMarker(fromCoords,{ radius:6, color:'#045', fillColor:style.color, fillOpacity:1 });
        const toMarker = L.circleMarker(toCoords,{ radius:6, color:'#045', fillColor:'#3db9ff', fillOpacity:1 });
        window.routeLayer = L.layerGroup([line, fromMarker, toMarker]).addTo(map);
        try{ map.fitBounds(line.getBounds().pad(0.1)); }catch(e){}
        if(opts.alternativeRoute){
          const altCoords = opts.alternativeRoute.geometry.coordinates.map(c=>[c[1],c[0]]);
          L.polyline(altCoords,{color:'#888',weight:4,dashArray:'6,8',opacity:0.7}).addTo(map);
        }
      }catch(e){ console.error('renderRoute error', e); }
    }
    async function calculateRoute(){
      const fromEl=$('from'), toEl=$('to'), routeInfo=$('routeInfo');
      const aQ = fromEl?fromEl.value.trim():'';
      const bQ = toEl?toEl.value.trim():'';
      if(!aQ||!bQ){ if(routeInfo) routeInfo.textContent='Inserisci partenza e arrivo'; return; }
      try{
        if(routeInfo) routeInfo.textContent='Localizzo...';
        const [aObj,bObj] = await Promise.all([geocodeSafe(aQ), geocodeSafe(bQ)]);
        if(!aObj||!bObj){ if(routeInfo) routeInfo.textContent='Localit√† non trovate'; return; }
        if(routeInfo) routeInfo.textContent='Calcolo percorso...';
        const modeVal = $('mode')?$('mode').value:'driving-car';
        const profileMap = {'driving-car':'driving','cycling-regular':'cycling','foot-walking':'walking'};
        const profile = profileMap[modeVal] || 'driving';
        const route = await fetchOsrmRoute(profile, aObj.coords, bObj.coords, true);
        if(!route){ if(routeInfo) routeInfo.textContent='Nessun percorso trovato'; return; }
        renderRoute(route, aObj.coords, bObj.coords, modeVal);
        if(routeInfo) routeInfo.textContent = `${(route.distance/1000).toFixed(1)} km ‚Ä¢ ${Math.round(route.duration/60)} min`;
      }catch(e){ console.error('calculateRoute error', e); if(routeInfo) routeInfo.textContent='Errore nel calcolo percorso'; }
    }

    /* ---------- Bookings submit (with local fallback) ---------- */
    async function submitBookingFromUI(){
      const structSel=$('quickStructure'); if(!structSel) return alert('Nessuna struttura selezionata');
      const selectedVal = structSel.value;
      const info = window._popupBookingStore[selectedVal] || null;
      if(!info) return alert('Seleziona una struttura prima di prenotare');
      const booking = { name: info.name||'', city: info.city||'', type: info.type||'', date: $('quickDate')?.value || '', user: $('quickName')?.value || 'You', metadata: info };

      // save locally first
      const localId = uid('bk');
      BOOKS.push({ id: localId, structureName: booking.name, date: booking.date, name: booking.user, city: booking.city });
      save(K_BOOKS, BOOKS);
      if($('bookings')) $('bookings').textContent = `${BOOKS.length} prenotazione/i (demo)`;

      // If endpoint configured, try to send to server (Supabase REST)
      if(API_BOOKINGS_ENDPOINT && API_BOOKINGS_ENDPOINT.length){
        try{
          const headers = { 'Content-Type':'application/json' };
          if(VITE_SUPABASE_ANON_KEY){
            headers['apikey'] = VITE_SUPABASE_ANON_KEY;
            headers['Authorization'] = 'Bearer ' + VITE_SUPABASE_ANON_KEY;
          }
          headers['Prefer'] = 'return=representation';
          const body = [booking];
          console.info('Invio booking a endpoint', API_BOOKINGS_ENDPOINT, 'body=', body);
          const r = await fetch(API_BOOKINGS_ENDPOINT, { method:'POST', headers, body: JSON.stringify(body) });
          const txt = await r.text();
          let resp;
          try{ resp = JSON.parse(txt); }catch(e){ resp = txt; }
          console.info('Booking response status=', r.status, 'body=', resp);
          if(!r.ok) {
            throw new Error('booking failed '+r.status+' '+JSON.stringify(resp));
          }
          if($('quickMsg')) $('quickMsg').textContent='Prenotazione inviata (server)';
          return resp;
        }catch(e){
          console.error('submitBooking error', e);
          if($('quickMsg')) $('quickMsg').textContent='Errore invio prenotazione (server)';
          // keep local copy
        }
      } else {
        if($('quickMsg')) $('quickMsg').textContent = 'Prenotazione salvata localmente (demo)';
      }
    }

    /* ---------- UI rendering helpers ---------- */
    function renderProfiles(){ const wrap=$('profiles'); if(!wrap) return; wrap.innerHTML=''; PROFILES.forEach(p=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(p.name)}</strong><div class="small">${escapeHtml(p.job)} ‚Äî ${escapeHtml(p.city)}</div></div><div><button class="btn-outline" data-action="open" data-id="${escapeHtml(p.id)}">Apri</button></div></div><div class="small" style="margin-top:6px">${escapeHtml(p.bio||'')}</div>`; wrap.appendChild(el); el.querySelector('[data-action="open"]')?.addEventListener('click', ()=>openProfile(p.id)); }); }
    function renderGlobalFeed(){ const wrap=$('globalFeed'); if(!wrap) return; wrap.innerHTML=''; const list = (CHATS && CHATS.global) ? CHATS.global.slice().reverse() : []; list.forEach(p=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div style="font-weight:700">${escapeHtml(p.user||'')}</div><div class="small" style="margin-top:6px">${escapeHtml(p.txt||'')}</div>`; wrap.appendChild(el); }); }

    /* ---------- Bind UI events ---------- */
    function bind(){
      $('btnNewGroup')?.addEventListener('click', ()=>showModal('modalGroup'));
      $('gCancel')?.addEventListener('click', ()=>hideModal('modalGroup'));
      $('gSave')?.addEventListener('click', ()=>createGroup());
      $('filterCity')?.addEventListener('change', ()=>renderGroups());
      $('chatSend')?.addEventListener('click', ()=>sendChat());
      $('chatInput')?.addEventListener('keypress', e=>{ if(e.key==='Enter') sendChat(); });
      $('btnSwitchGlobal')?.addEventListener('click', ()=> setActiveChat({ type:'global', id:null }));
      $('postAttachPos')?.addEventListener('click', ()=> attachPosition());
      $('postPublish')?.addEventListener('click', ()=> publishPost());
      $('btnOpenMap')?.addEventListener('click', ()=>{ initMap(); setTimeout(()=> map.invalidateSize && map.invalidateSize(),200); });
      $('btnRoute')?.addEventListener('click', ()=> calculateRoute());
      $('quickSearch')?.addEventListener('click', ()=> populateQuickStructures());
      $('quickBook')?.addEventListener('click', ()=> submitBookingFromUI());
      $('quickCity')?.addEventListener('change', ()=> { populateQuickStructures(); });
      $('quickType')?.addEventListener('change', ()=> { populateQuickStructures(); });
      $('quickPriceFilter')?.addEventListener('change', ()=> { populateQuickStructures(); });
      bindQuickStructureAutoUpdate();
    }

    function showModal(id){ const el=$(id); if(!el) return; el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function hideModal(id){ const el=$(id); if(!el) return; el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

    /* ---------- Small boot ---------- */
    async function boot(){
      try{ history.replaceState(null,'','/'); } catch(e){}
      bind();
      renderGroups();
      renderProfiles();
      renderGlobalFeed();
      populateQuickFilters();
      populateQuickList?.();
      initMap();
      attachPopupDelegation();
      await loadPlacesToMap();
      // select default chat
      setActiveChat({ type:'global', id:null });
      if($('bookings')) $('bookings').textContent = BOOKS.length ? `${BOOKS.length} prenotazione/i (demo)` : 'Nessuna prenotazione';
      console.info('Demo ready ‚Äî API_PLACES_ENDPOINT -> Supabase -> demo local fallback. All core features enabled.');
      window.smnDebug = ()=>({ GROUPS, CHATS, BOOKS, popupStore: window._popupBookingStore, structuresIndex: window._structuresIndex, availableCities: Array.from(window._availableCities||[]) });
    }

    function populateQuickList(){ const sel=$('quickStructure'), resultsWrap=$('quickResults'); if(!sel||!resultsWrap) return; if(!sel.childElementCount){ const o=document.createElement('option'); o.value=''; o.textContent='Seleziona struttura'; sel.appendChild(o);} resultsWrap.innerHTML = ''; }

    // helpers
    function openProfile(id){ const p=PROFILES.find(x=>x.id===id); if(p) alert(`${p.name}\n${p.job}\n${p.city}\n\n${p.bio}`); else alert('Profilo non trovato'); }
    function openPrivateChat(profileIdOrName){ let pid = profileIdOrName; const found = PROFILES.find(p=>p.id===profileIdOrName||p.name===profileIdOrName); if(found) pid = found.id; setActiveChat({ type:'private', id: pid }); }

    window.openProfile = openProfile; window.openPrivateChat = openPrivateChat;

    // initial render of groups and attach small handlers
    renderGroups();

    // expose selected helpers
    window.selectStructureFromPopup = selectStructureFromPopup;
    window.submitBookingFromUI = submitBookingFromUI;
    window.loadPlacesToMap = loadPlacesToMap;
    window.populateQuickFilters = populateQuickFilters;

    boot();

  })();
  </script>

  <script>
    (function(){
      const btnDemo = document.getElementById('showDemo');
      const btnReact = document.getElementById('showReact');
      const btnAuth = document.getElementById('openAuth');
      const root = document.getElementById('root');
      const demo = document.getElementById('demoContainer');
      function showReact(){ if(root) root.classList.remove('view-hidden'), root.style.display='block'; if(demo) demo.style.display='none'; }
      function showDemo(){ if(root) root.classList.add('view-hidden'), root.style.display='none'; if(demo) demo.style.display='block'; }
      btnDemo?.addEventListener('click', ()=> showDemo());
      btnReact?.addEventListener('click', ()=> showReact());
      btnAuth?.addEventListener('click', ()=>{ showReact(); window.dispatchEvent(new CustomEvent('navigateToAuth')); });
      try { if(location && location.pathname === '/auth') showReact(); else showDemo(); } catch(e){ showDemo(); }
    })();
  </script>
</body>
</html>